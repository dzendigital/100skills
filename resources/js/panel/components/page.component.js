!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).NestedSort=t()}(this,(function(){"use strict";var e=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i};var t=function(t){if(Array.isArray(t))return e(t)};var s=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)};var i=function(t,s){if(t){if("string"==typeof t)return e(t,s);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?e(t,s):void 0}};var a=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var r=function(e){return t(e)||s(e)||i(e)||a()};var n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function o(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=function(e,t,s){return t&&o(e.prototype,t),s&&o(e,s),e};var d=function(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e},h=function(){function e(t){var s=t.data,i=t.propertyMap,a=void 0===i?{}:i;n(this,e),this.data=s,this.sortedData=[],this.sortedDataDomArray=[],this.propertyMap=a,this.maybeTransformData()}return l(e,[{key:"maybeTransformData",value:function(){if(Object.keys(this.propertyMap).length&&Array.isArray(this.data)){var e=this.getItemPropProxyName.bind(this);this.data=this.data.map((function(t){return new Proxy(t,{get:function(t,s,i){return Reflect.get(t,e(s),i)}})}))}}},{key:"getItemPropProxyName",value:function(e){return Object.prototype.hasOwnProperty.call(this.propertyMap,e)?this.propertyMap[e]:e}},{key:"isTopLevelItem",value:function(e){return!e.parent}},{key:"sortListItems",value:function(){var e=this,t=r(this.data),s=t.filter((function(t){return e.isTopLevelItem(t)})).sort((function(e,t){return e.order&&t.order?e.order-t.order:0})),i=t.filter((function(t){return!e.isTopLevelItem(t)})).reduce((function(e,t){return Object.prototype.hasOwnProperty.call(e,t.parent)?e[t.parent].push(t):e[t.parent]=[t],e}),{});return Object.keys(i).forEach((function(e){i[e].sort((function(e,t){return e.order&&t.order?e.order-t.order:0}))})),this.sortedData=[].concat(r(s),r(Object.values(i).flat())),this.sortedData}},{key:"createItemElement",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"li",s=e.id,i=e.text,a=document.createElement(t);return a.dataset.id=s,"li"===t&&(a.innerHTML=i),a}},{key:"elementIsParentOfItem",value:function(e,t){return e.dataset.id==="".concat(t.parent)}},{key:"getParentNodeOfItem",value:function(e,t,s){return e.querySelector("".concat(s,'[data-id="').concat(t.parent,'"]'))}},{key:"elementIsAncestorOfItem",value:function(e,t){return!!this.getParentNodeOfItem(e,t,"li")}},{key:"getDirectListParentOfItem",value:function(e,t){return this.getParentNodeOfItem(e,t,"ol")}},{key:"maybeAppendItemToParentDom",value:function(e){var t=this,s=e.parent,i=this.sortedDataDomArray.find((function(s){return t.elementIsParentOfItem(s,e)||t.elementIsAncestorOfItem(s,e)}));if(!i)return!1;var a=this.createItemElement(e),r=this.getDirectListParentOfItem(i,e);r||(r=this.createItemElement({id:s},"ol"),(this.getParentNodeOfItem(i,e,"li")||i).appendChild(r));return r.appendChild(a),!0}},{key:"getListItemsDom",value:function(){var e=this;this.sortedDataDomArray=[];for(var t=[];t.length!==this.sortListItems().length;)t=this.sortedData.reduce((function(t,s){var i,a=s.id;if(t.includes(a))return t;if(s.parent)i=e.maybeAppendItemToParentDom(s);else{var r=e.createItemElement(s);e.sortedDataDomArray.push(r),i=!0}return i&&t.push(a),t}),t);return this.sortedDataDomArray}},{key:"convertDomToData",value:function(e){var t=this;return Array.from(e.querySelectorAll("li")).map((function(e){var s,i=e.parentNode,a=i.dataset.id,r=Array.from(i.children).findIndex((function(t){return t===e}))+1;return d(s={},t.getItemPropProxyName("id"),e.dataset.id),d(s,t.getItemPropProxyName("parent"),a),d(s,t.getItemPropProxyName("order"),r),s}))}},{key:"render",value:function(){var e=document.createElement("ol");return this.getListItemsDom().forEach((function(t){return e.appendChild(t)})),e}}]),e}();return function(){function e(t){var s=t.actions,i=(s=void 0===s?{}:s).onDrop,a=t.data,r=t.droppingEdge,o=void 0===r?15:r,l=t.el,d=t.init,h=void 0===d||d,c=t.listClassNames,u=t.listItemClassNames,g=t.nestingLevels,f=t.propertyMap,m=void 0===f?{}:f;n(this,e),this.data=a,this.selector=l,this.sortableList=null,this.placeholderList=null,this.placeholderInUse=null,this.draggedNode=null,this.targetedNode=null,this.listClassNames=this.createListClassNamesArray(c),this.mainListClassName=this.listClassNames[0]||"nested-sort",this.listItemClassNames=this.createListClassNamesArray(u),this.propertyMap=m,this.actions={onDrop:i},this.initialised=!1,this.targetNode={X:null,Y:null},this.distances={droppingEdge:o,droppingEdgeNegative:-1*o,mouseTo:{targetedElTop:void 0}},this.dimensions={targetedEl:{H:void 0}},this.cursor={X:null,Y:null},this.classNames={dragged:"ns-dragged",placeholder:"ns-placeholder",targeted:"ns-targeted"},this.listEventListeners={dragover:this.onDragOver.bind(this),dragstart:this.onDragStart.bind(this),dragenter:this.onDragEnter.bind(this),dragend:this.onDragEnd.bind(this),drop:this.onDrop.bind(this)};var p=parseInt(g);this.nestingLevels=isNaN(p)?-1:p,this.listInterface=this.getListInterface(),this.maybeInitDataDom(),this.addListAttributes(),h&&this.initDragAndDrop()}return l(e,[{key:"getListInterface",value:function(){return Array.isArray(this.data)&&this.data.length||(this.selector instanceof HTMLElement?this.selector:document.querySelector(this.selector))instanceof HTMLOListElement?HTMLOListElement:HTMLUListElement}},{key:"getDataEngine",value:function(){return this.dataEngine instanceof h||(this.dataEngine=new h({data:this.data,propertyMap:this.propertyMap})),this.dataEngine}},{key:"createListClassNamesArray",value:function(e){return e?Array.isArray(e)?e:e.split(" "):[]}},{key:"maybeInitDataDom",value:function(){if(Array.isArray(this.data)&&this.data.length){var e=document.querySelector(this.selector),t=this.getDataEngine().render();e.innerHTML="",e.appendChild(t)}}},{key:"getListTagName",value:function(){return this.listInterface===HTMLOListElement?"ol":"ul"}},{key:"getSortableList",value:function(){if(this.sortableList instanceof this.listInterface)return this.sortableList;if(this.selector instanceof this.listInterface)this.sortableList=this.selector;else{var e=document.querySelector(this.selector);this.sortableList=e instanceof this.listInterface?e:e.querySelector(this.getListTagName())}return this.sortableList}},{key:"addListAttributes",value:function(){var e,t=this,s=this.getSortableList();(e=s.classList).add.apply(e,r(this.listClassNames.concat(this.mainListClassName))),s.querySelectorAll(this.getListTagName()).forEach((function(e){var s;(s=e.classList).add.apply(s,r(t.listClassNames))})),s.querySelectorAll("li").forEach((function(e){var s;(s=e.classList).add.apply(s,r(t.listItemClassNames))}))}},{key:"toggleMainListLifeCycleClassName",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t="".concat(this.mainListClassName,"--enabled"),s=this.getSortableList().classList;return e?s.add(t):s.remove(t)}},{key:"toggleListItemAttributes",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.getSortableList().querySelectorAll("li").forEach((function(t){t.setAttribute("draggable",e)}))}},{key:"toggleListEventListeners",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],s=this.getSortableList();Object.keys(this.listEventListeners).forEach((function(i){t?s.removeEventListener(i,e.listEventListeners[i]):s.addEventListener(i,e.listEventListeners[i],!1)}))}},{key:"initDragAndDrop",value:function(){this.initialised||(this.toggleListEventListeners(),this.initPlaceholderList(),this.toggleListItemAttributes(),this.toggleMainListLifeCycleClassName(),this.initialised=!0)}},{key:"init",value:function(){this.initDragAndDrop()}},{key:"destroy",value:function(){this.toggleListEventListeners(!0),this.toggleListItemAttributes(!1),this.toggleMainListLifeCycleClassName(!1),this.initialised=!1}},{key:"removeClassFromEl",value:function(e,t){e&&e.classList.contains(t)&&e.classList.remove(t)}},{key:"canBeTargeted",value:function(e){return!(!this.draggedNode||this.draggedNode===e)&&("LI"===e.nodeName||e instanceof this.listInterface&&e.classList.contains(this.classNames.placeholder))}},{key:"onDragStart",value:function(e){this.draggedNode=e.target,this.draggedNode.classList.add(this.classNames.dragged),e.dataTransfer.setData("text","Drag started!")}},{key:"onDragOver",value:function(e){e.preventDefault(),this.updateCoordination(e),this.managePlaceholderLists(e)}},{key:"onDragEnter",value:function(e){this.canBeTargeted(e.target)&&(this.removeClassFromEl(this.targetedNode,this.classNames.targeted),this.targetedNode=e.target,this.targetedNode.classList.add(this.classNames.targeted))}},{key:"onDragEnd",value:function(e){e.stopPropagation(),this.removeClassFromEl(this.draggedNode,this.classNames.dragged),this.removeClassFromEl(this.targetedNode,this.classNames.targeted),this.cleanupPlaceholderLists(),this.draggedNode=null,this.targetedNode=null}},{key:"onDrop",value:function(e){e.stopPropagation(),this.maybeDrop(),this.cleanupPlaceholderLists(),"function"==typeof this.actions.onDrop&&this.actions.onDrop(this.getDataEngine().convertDomToData(this.getSortableList()))}},{key:"updateCoordination",value:function(e){this.calcMouseCoords(e),this.calcMouseToTargetedElDist()}},{key:"getDropLocation",value:function(){if(this.canBeDropped()){if("LI"===this.targetedNode.nodeName&&!this.cursorIsIndentedEnough())return"before";if(this.targetedNode instanceof this.listInterface)return"inside"}}},{key:"maybeDrop",value:function(e){var t=this.getDropLocation();t&&this.dropTheItem(t,e)}},{key:"dropTheItem",value:function(e){switch(e){case"before":this.targetedNode.parentNode.insertBefore(this.draggedNode,this.targetedNode);break;case"inside":this.targetedNode.appendChild(this.draggedNode)}}},{key:"calcMouseCoords",value:function(e){this.cursor.X=e.clientX,this.cursor.Y=e.clientY}},{key:"calcMouseToTargetedElDist",value:function(){if(this.targetedNode){var e=this.targetedNode.getBoundingClientRect();this.targetNode.X=e.left,this.targetNode.Y=e.top;var t=this.targetNode.Y-this.cursor.Y;this.distances.mouseTo.targetedElTop=t,this.distances.mouseTo.targetedElTopAbs=Math.abs(t),this.dimensions.targetedEl.H=this.targetedNode.clientHeight,this.distances.mouseTo.targetedElBot=this.distances.mouseTo.targetedElTopAbs-this.dimensions.targetedEl.H}}},{key:"areNested",value:function(e,t){return t&&Array.from(t.querySelectorAll("li")).some((function(t){return t===e}))}},{key:"cursorIsIndentedEnough",value:function(){return this.cursor.X-this.targetNode.X>50}},{key:"mouseIsTooCloseToTop",value:function(){return this.cursor.Y-this.targetNode.Y<this.distances.droppingEdge}},{key:"managePlaceholderLists",value:function(e){var t=this;this.analysePlaceHolderSituation(e).forEach((function(e){switch(e){case"add":t.cleanupPlaceholderLists(),t.addPlaceholderList();break;case"cleanup":t.cleanupPlaceholderLists()}}))}},{key:"targetedNodeIsPlaceholder",value:function(){return this.targetedNode instanceof this.listInterface&&this.targetedNode.classList.contains(this.classNames.placeholder)}},{key:"getTargetedNodeDepth",value:function(){for(var e=0,t=this.targetedNode,s=this.getSortableList();s!==t.parentElement;)t.parentElement instanceof this.listInterface&&e++,t=t.parentElement;return e}},{key:"nestingThresholdReached",value:function(){return!(this.nestingLevels<0)&&(0===this.nestingLevels||this.getTargetedNodeDepth()>=this.nestingLevels)}},{key:"analysePlaceHolderSituation",value:function(){if(!this.targetedNode||this.areNested(this.targetedNode,this.draggedNode))return[];var e=[];return!this.cursorIsIndentedEnough()||this.mouseIsTooCloseToTop()?this.targetedNodeIsPlaceholder()||e.push("cleanup"):this.targetedNode===this.draggedNode||"LI"!==this.targetedNode.nodeName||this.targetedNode.querySelectorAll(this.getListTagName()).length||this.nestingThresholdReached()||e.push("add"),e}},{key:"animatePlaceholderList",value:function(){this.placeholderInUse.style.minHeight="0",this.placeholderInUse.style.transition="min-height ease .2s",this.placeholderInUse.style.minHeight="".concat(this.draggedNode.offsetHeight,"px")}},{key:"addPlaceholderList",value:function(){this.getPlaceholderList(),this.targetedNode.appendChild(this.placeholderInUse),this.animatePlaceholderList()}},{key:"targetNodeIsIdentified",value:function(){return!!this.targetedNode}},{key:"targetNodeIsBeingDragged",value:function(){return this.targetNodeIsIdentified()&&this.targetedNode===this.draggedNode}},{key:"targetNodeIsListWithItems",value:function(){return this.targetNodeIsIdentified()&&this.targetedNode instanceof this.listInterface&&this.targetedNode.querySelectorAll("li").length}},{key:"canBeDropped",value:function(){return this.targetNodeIsIdentified()&&!this.targetNodeIsBeingDragged()&&!this.targetNodeIsListWithItems()&&!this.areNested(this.targetedNode,this.draggedNode)}},{key:"cleanupPlaceholderLists",value:function(){var e=this;this.getSortableList().querySelectorAll(this.getListTagName()).forEach((function(t){t.querySelectorAll("li").length?t.classList.contains(e.classNames.placeholder)&&(t.classList.remove(e.classNames.placeholder),t.style.minHeight="auto",t.dataset.id=t.parentNode.dataset.id):t.remove()}))}},{key:"initPlaceholderList",value:function(){var e;this.placeholderList=document.createElement(this.getListTagName()),(e=this.placeholderList.classList).add.apply(e,[this.classNames.placeholder].concat(r(this.listClassNames)))}},{key:"getPlaceholderList",value:function(){return this.placeholderInUse=this.placeholderList.cloneNode(!0),this.placeholderInUse}}]),e}()}));
